<!-- Module User's Guide -->

<chapter>
	
	<title>&adminguide;</title>
	
	<section>
	<title>Overview</title>
	<para>
	This module implement various functions and checks related to SIP message
	handling and URI handling.
	</para>
	<para>
	It offers some functions related to handle ringing. In a parallel forking
	scenario you get several 183s with SDP. You don't want that your customers
	hear more than one ringtone or answer machine in parallel on the phone.
	So its necessary to drop the 183 in this cases and send a 180 instead.
	</para>
	<para>
	This module provides a function to answer OPTIONS requests which 
	are directed to the server itself. This means an OPTIONS request 
	which has the address of the server in the request URI, and no 
	username in the URI. The request will be answered with a 200 OK 
	which the capabilities of the server.
	</para>
	<para>
	To answer OPTIONS request directed to your server is the easiest
	way for is-alive-tests on the SIP (application) layer from remote 
	(similar to ICMP echo requests, also known as <quote>ping</quote>, 
	on the network layer).
	</para>
	</section>
	<section>
	<title>Dependencies</title>
	<section>
		<title>&kamailio; Modules</title>
		<para>
		The following modules must be loaded before this module:
			<itemizedlist>
			<listitem>
			<para>
				<emphasis>sl</emphasis> -- Stateless replies.
			</para>
			</listitem>
			</itemizedlist>
		</para>
	</section>
	<section>
		<title>External Libraries or Applications</title>
		<para>
		The following libraries or applications must be installed before 
		running &kamailio; with this module loaded:
			<itemizedlist>
			<listitem>
			<para>
				<emphasis>None</emphasis>.
			</para>
			</listitem>
			</itemizedlist>
		</para>
	</section>
	</section>
	
	<section>
		<title>Exported Parameters</title>
		<section>
			<title><varname>ring_timeout</varname> (int)</title>
			<para>
			Timeout value in seconds, define how long the call-id is stored in the internal list.
			A reasonable value is <quote>30</quote>.
			</para>
			<para>
			<emphasis>
				Default value is <quote>0</quote>.
			</emphasis>
			</para>
			<example>
			<title>Set <varname>ring_timeout</varname> parameter</title>
				<programlisting format="linespecific">
...
modparam("utils", "ring_timeout", "30")
...
				</programlisting>
			</example>
		</section>
			<section>
		<title><varname>options_accept</varname> (string)</title>
		<para>
			This parameter is the content of the Accept header field.
			Note: it is not clearly written in RFC3261 if a proxy should
			accept any content (the default <quote>*/*</quote>) because 
			it does not care about content. Or if it does not accept 
			any content, which is <quote></quote>.
		</para>
		<para>
		<emphasis>
			Default value is <quote>*/*</quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>options_accept</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("options", "options_accept", "application/*")
...
</programlisting>
		</example>
	</section>
	<section>
		<title><varname>options_accept_encoding</varname> (string)</title>
		<para>
			This parameter is the content of the Accept-Encoding header field.
			Please do not change the default value because &kamailio; 
			does not support any encodings yet.
		</para>
		<para>
		<emphasis>
			Default value is <quote></quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>options_accept_encoding</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("options", "options_accept_encoding", "gzip")
...
</programlisting>
		</example>
	</section>

		<section>
		<title><varname>contact_flds_separator</varname> (string)</title>
		<para>
		First char of this parameter is used as separator for encoding/decoding 
		Contact header.
		</para>
		<warning>
		<para>
			First char of this field must be set to a value which is not used 
			inside username,password or other fields of contact. Otherwise it 
			is possible for the decoding step to fail/produce wrong results.
		</para>
		</warning>
		<para>
		<emphasis>
			Default value is <quote>*</quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>db_url</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("mangler", "contact_flds_separator", "-")
...
</programlisting>
		</example>
		<para>
		then an encoded uri might look 
		sip:user-password-ip-port-protocol@PublicIP
		</para>
	</section>


	<section>
		<title><varname>options_accept_language</varname> (string)</title>
		<para>
			This parameter is the content of the Accept-Language header field.
			You can set any language code which you prefer for error 
			descriptions from other devices, but presumably there are not
			much devices around which support other languages then the 
			default English.
		</para>
		<para>
		<emphasis>
			Default value is <quote>en</quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>options_accept_language</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("options", "options_accept_language", "de")
...
</programlisting>
		</example>
	</section>
	<section>
		<title><varname>options_support</varname> (string)</title>
		<para>
			This parameter is the content of the Support header field.
			Please do not change the default value, because &kamailio; currently 
			does not support any of the SIP extensions registered at the IANA.
		</para>
		<para>
		<emphasis>
			Default value is <quote></quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>options_support</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("options", "options_support", "100rel")
...
</programlisting>
		</example>
	</section>
	</section>

	<section>
	<title>Exported Functions</title>
		<section>
			<title>
				<function moreinfo="none">ring_insert_callid()</function>
			</title>
			<para>
			Inserting the call-id in the internal list, which is checked when
			further replies arrive. Any 183 reply that is received during the
			timeout value will be converted to a 180 message. Please not that you
			need to set a positive timeout value in order to use this function.
			</para>
			<para>
			The function returns TRUE on success, and FALSE during processing failures.
			</para>
			<para>
			This function can be used from REQUEST_ROUTE and FAILURE_ROUTE.
			</para>
			<example>
				<title><function>ring_insert_callid()</function> usage</title>
				<programlisting format="linespecific">
...
ring_insert_callid();
...
				</programlisting>
			</example>
		</section>
			<section>
		<title>
		<function moreinfo="none">options_reply()</function>
		</title>
		<para>
			This function checks if the request method is OPTIONS and
			if the request URI does not contain an username. If both
			is true the request will be answered stateless with 
			<quote>200 OK</quote> and the capabilities from the modules
			parameters.
		</para>
		<para>
			It sends <quote>500 Server Internal Error</quote> for some errors
			and returns false if it is called for a wrong request.
		</para>
		<para>
			The check for the request method and the missing username is
			optional because it is also done by the function itself. But
			you should not call this function outside the myself check
			because in this case the function could answer OPTIONS requests
			which are sent to you as outbound proxy but with an other
			destination then your proxy (this check is currently missing
			in the function).
		</para>
		<para>
		This function can be used from REQUEST_ROUTE.
		</para>
		<example>
		<title><function>options_reply</function> usage</title>
		<programlisting format="linespecific">
...
if (uri==myself) {
	if ((method==OPTIONS) &amp;&amp; (! uri=~"sip:.*[@]+.*")) {
		options_reply();
	}
}
...
</programlisting>
		</example>
	</section>

	<section>
		<title>
		<function moreinfo="none">is_user(username)</function>
		</title>
		<para>
		Check if the username in credentials matches the given username.
		</para>
		<para>Meaning of the parameters is as follows:</para>
		<itemizedlist>
		<listitem>
			<para><emphasis>username</emphasis> - Username string.
			</para>
		</listitem>
		</itemizedlist>
		<para>
		This function can be used from REQUEST_ROUTE.
		</para>
		<example>
		<title><function>is_user</function> usage</title>
		<programlisting format="linespecific">
...
if (is_user("john")) {
	...
};
...
</programlisting>
		</example>
	</section>
	<section>
		<title>
		<function moreinfo="none">has_totag()</function>
		</title>
		<para>
		Check if To header field uri contains tag parameter.
		</para>
		<para>
		This function can be used from REQUEST_ROUTE.
		</para>
		<example>
		<title><function>has_totag</function> usage</title>
		<programlisting format="linespecific">
...
if (has_totag()) {
	...
};
...
</programlisting>
		</example>
	</section>
	<section>
		<title>
		<function moreinfo="none">uri_param(param)</function>
		</title>
		<para>
		Find if Request URI has a given parameter with no value
		</para>
		<para>Meaning of the parameters is as follows:</para>
		<itemizedlist>
		<listitem>
			<para><emphasis>param</emphasis> - parameter name to look for.
			</para>
		</listitem>
		</itemizedlist>
		<para>
		This function can be used from REQUEST_ROUTE.
		</para>
		<example>
		<title><function>uri_param</function> usage</title>
		<programlisting format="linespecific">
...
if (uri_param("param1")) {
	...
};
...
</programlisting>
		</example>
	</section>
	<section>
		<title>
		<function moreinfo="none">uri_param(param,value)</function>
		</title>
		<para>
		Find if Request URI has a given parameter with matching value
		</para>
		<para>Meaning of the parameters is as follows:</para>
		<itemizedlist>
		<listitem>
			<para><emphasis>param</emphasis> - parameter name to look for.
			</para>
		</listitem>
		<listitem>
			<para><emphasis>value</emphasis> - parameter value to match.
			</para>
		</listitem>
		</itemizedlist>
		<para>
		This function can be used from REQUEST_ROUTE.
		</para>
		<example>
		<title><function>uri_param</function> usage</title>
		<programlisting format="linespecific">
...
if (uri_param("param1","value1")) {
	...
};
...
</programlisting>
		</example>
	</section>
	<section>
		<title>
		<function moreinfo="none">add_uri_param(param)</function>
		</title>
		<para>
		Add to RURI a parameter (name=value);
		</para>
		<para>Meaning of the parameters is as follows:</para>
		<itemizedlist>
		<listitem>
			<para><emphasis>param</emphasis> - parameter to be appended in
			<quote>name=value</quote> format.
			</para>
		</listitem>
		</itemizedlist>
		<para>
		This function can be used from REQUEST_ROUTE.
		</para>
		<example>
		<title><function>add_uri_param</function> usage</title>
		<programlisting format="linespecific">
...
add_uri_param("nat=yes");
...
</programlisting>
		</example>
	</section>
	<section>
		<title>
		<function moreinfo="none">tel2sip()</function>
		</title>
		<para>
		Converts RURI, if it is tel URI, to SIP URI.  Returns true, only if
		conversion succeeded or if no conversion was needed (like RURI
		was not tel URI.
		</para>
		<para>
		This function can be used from REQUEST_ROUTE.
		</para>
		<example>
		<title><function>tel2sip</function> usage</title>
		<programlisting format="linespecific">
...
tel2sip();
...
</programlisting>
		</example>
	</section>
	<section>
		<title>
		<function moreinfo="none">is_uri_user_e164(pseudo-variable)</function>
		</title>
		<para>
		Checks if userpart of URI stored in pseudo variable is
		E164 number.
		</para>
		<para>
		This function can be used from REQUEST_ROUTE and FAILURE_ROUTE.
		</para>
		<example>
		<title><function>is_uri_user_e164</function> usage</title>
		<programlisting format="linespecific">
...
if (is_uri_user_e164("$fu")) {  # Check From header URI user part
   ...
}
if (is_uri_user_e164("$avp(i:705)") {
   # Check user part of URI stored in avp i:705
   ...
};
...
</programlisting>
		</example>
	</section>

	<section>
		<title>
		<function moreinfo="none">encode_contact(encoding_prefix)</function>
		</title>
		<para>
		This function will encode uri-s inside Contact header in the following 
		manner
		sip:username:password@ip:port;transport=protocol goes
		sip:enc_pref*username*ip*port*protocol@public_ip * is the default 
		separator.
		</para>
		<para>
		The function returns negative on error, 1 on success.
		</para>
		<para>Meaning of the parameters is as follows:</para>
		<itemizedlist>
		<listitem>
			<para><emphasis>encoding_prefix</emphasis> - Something to allow us 
			to determine that a contact is encoded publicip--a routable &ip;, 
			most probably you should
			put your external &ip; of your &nat; box.
			</para>
		</listitem>
		</itemizedlist>
		<para>
		This function can be used from REQUEST_ROUTE, ONREPLY_ROUTE.
		</para>
		<example>
		<title><function>encode_contact</function> usage</title>
		<programlisting format="linespecific">
...
if (src_ip == 10.0.0.0/8) encode_contact("enc_prefix","193.175.135.38"); 
...
</programlisting>
		</example>
	</section>

	<section>
		<title>
		<function moreinfo="none">decode_contact()</function>
		</title>
		<para>
		This function will decode the &uri; in first line in packets which 
		come with encoded &uri; in the following manner 
		sip:enc_pref*username*ip*port*protocol@public_ip goes to
		sip:username:password@ip:port;transport=protocol It uses the default 
		set parameter for contact encoding separator.
		</para>
		<para>
		The function returns negative on error, 1 on success.
		</para>
		<para>Meaning of the parameters is as follows:</para>
		<para>
		This function can be used from REQUEST_ROUTE.
		</para>
		<example>
		<title><function>decode_contact</function> usage</title>
		<programlisting format="linespecific">
...
if (uri =~ "^enc*") { decode_contact(); }
...
</programlisting>
		</example>
	</section>

	<section>
		<title>
		<function moreinfo="none">decode_contact_header()</function>
		</title>
		<para>
		This function will decode &uri;s inside Contact header in the 
		following manner sip:enc_pref*username*ip*port*protocol@public_ip goes 
		to sip:username:password@ip:port;transport=protocol. It uses the 
		default set parameter for contact encoding separator.
		</para>
		<para>
		The function returns negative on error, 1 on success.
		</para>
		<para>Meaning of the parameters is as follows:</para>
		<para>
		This function can be used from REQUEST_ROUTE, ONREPLY_ROUTE.
		</para>
		<example>
		<title><function>decode_contact_header</function> usage</title>
		<programlisting format="linespecific">
...
if (uri =~ "^enc*") { decode_contact_header(); }
...
</programlisting>
		</example>
	</section>
	</section>

</chapter>
