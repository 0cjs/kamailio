OpenSER PURPLE MODULE
---------------------

Copyright (C) 2008 Atos Worldline
Contact: Eric PTAK <eric.ptak@atosorigin.com>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 2 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.


Introduction
------------
Purple module is a multi-protocol instant-messaging gateway module which use libpurple, the library on bottom of Pidgin (ex-gaim).
This plugin was wrote in order to proof the concept of gateway between SIP and MSN/Live networks. As libpurple is written to code multi-protocol 
graphic IM clients , it provides a high level API in order to manipulate accounts, contacts, contacts lists, conversations and more. So this module 
provides a multi-protocol IM/Presence client running inside OpenSER with an account for each protocols used by each SIP user whereas libpurple is 
designed for a graphic client for only one user. So it's no really adapted to a production environment with a huge user count but can be used in order 
to demonstrate the concept or to use it in SOHO environment.

Requirements
------------
* OpenSER fork 1.5.x devel trunk (eg. Kamailio/OpenSIPS)
* modules : presence*, pua, db_?
* database
* libpurple from pidgin 2.5.2

PUA mod
-------
In order to compile the module, you'll need to add a PURPLE_PUBLISH preprocessor definition to modules/pua/hash.h after others *_PUBLISH.
* Kamailio :
[...]
#define RLS_SUBSCRIBE       1<<9
#define DIALOG_PUBLISH      1<<10
#define PURPLE_PUBLISH      1<<11

* OpenSIPS :
[...]
#define MI_SUBSCRIBE        1<<8
#define RLS_SUBSCRIBE       1<<9
#define PURPLE_PUBLISH      1<<10


openserctl mod
--------------
By default - and I don't know exactly why - there's some undefined symbol errors with libpurple shared object when using inside OpenSER.
To solve it, you have to force preload of the library by setting up LD_PRELOAD environment variable.
So you should add to your [openser|kam|opensips]ctl (adapt the path to your environment) :
export LD_PRELOAD=$LD_PRELOAD:/usr/local/lib/libpurple.so


Database scheme
---------------
The database is used to map SIP URIs with external accounts (eg. MSN)

	+----------+------------------+------+-----+---------+----------------+
	| Field    | Type             | Null | Key | Default | Extra          |
	+----------+------------------+------+-----+---------+----------------+
	| id       | int(10) unsigned | NO   | PRI | NULL    | auto_increment |
	| sip_user | varchar(128)     | NO   |     | NULL    |                |
	| ext_user | varchar(128)     | NO   |     | NULL    |                |
	| ext_prot | varchar(16)      | NO   |     | NULL    |                |
	| ext_pass | varchar(64)      | YES  |     | NULL    |                |
	+----------+------------------+------+-----+---------+----------------+

Details :
	* sip_user : user's SIP URI
	* ext_user : user's external account login
	* ext_prot : purple plugin id to use, except for gtalk
	* ext_pass : user's external account password

Example :
	+----+------------------+-----------------+----------------+----------+
	| id | sip_user         | ext_user        | ext_prot       | ext_pass |
	+----+------------------+-----------------+----------------+----------+
	|  1 | sip:alice@domain | alice@live.com  | prpl-msn-pecan | password |
	|  2 | sip:bob@domain   | bob@live.com    | prpl-msn-pecan | password |
	|  3 | sip:alice@domain | alice@gmail.com | gtalk          | password |
	|  4 | sip:bob@domain   | bob@gmail.com   | gtalk          | password |
	+----+------------------+-----------------+----------------+----------+


MySQL script :
	CREATE TABLE purplemap (
			id INT UNSIGNED PRIMARY KEY NOT NULL AUTO_INCREMENT,
			sip_user VARCHAR(128) NOT NULL,
			ext_user VARCHAR(128) NOT NULL,
			ext_prot VARCHAR(16) NOT NULL,
			ext_pass VARCHAR(64)
	);




Exported Parameters
-------------------
* db_url (string)
modparam("purple", "db_url", "mysql://kamailio:kamailiorw@localhost/kamailio")

* db_table (string)
modparam("purple", "db_table", "purplemap")

* httpProxy_host (string)
modparam("purple", "httpProxy_host", "10.26.52.12")

* httpProxy_port (int)
modparam("purple", "httpProxy_port", 3128)


Exported Functions
------------------
* purple_send_message
In order to filter messages from purple and avoid loops, the tag proto=purple is appended to the R-URI.

	if (is_method("MESSAGE")) {
		xlog("MESSAGE $ru from <$fu> to <$tu>\n");
		if (uri !~ "sip:.+@.+;proto=.+") {
				xlog("FORWARDED to PURPLE\n");
				purple_send_message();
				if (!lookup("location")) {
						sl_send_reply("200", "Accepted");
						exit;
				}
		}
	}


* purple_handle_publish
In order to filter publications from purple and avoid loops, the tag proto=purple is appended to the R-URI.

	if(is_method("PUBLISH")) {
			xlog("PUBLISH $ru from <$fu> to <$tu>\n");
			if($hdr(Sender)!= NULL)
					handle_publish("$hdr(Sender)");
			else
					handle_publish();
			if (uri !~ "sip:.+@.+;proto=.+")
					purple_handle_publish();
			t_release();
	}

* purple_handle_subscribe

	if(is_method("SUBSCRIBE")) {
			xlog("SUBSCRIBE $ru from <$fu> to <$tu>\n");
			handle_subscribe();
			if ($hdr(Event) == "presence")
					purple_handle_subscribe("$ruri", "$hdr(Expires)");
			t_release();
	}


Limitations
-----------
* Doesn't implement authorization requests from external accounts to SIP.

