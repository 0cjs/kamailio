EVAPI Module

Daniel-Constantin Mierla

   <miconda@gmail.com>

Edited by

Daniel-Constantin Mierla

   <miconda@gmail.com>

   Copyright © 2014 asipto.com
     __________________________________________________________________

   Table of Contents

   1. Admin Guide

        1. Overview
        2. Dependencies

              2.1. Kamailio Modules
              2.2. External Libraries or Applications

        3. Parameters

              3.1. workers (int)
              3.2. bind_addr (str)

        4. Functions

              4.1. evapi_relay(evdata)
              4.2. evapi_async_relay(evdata)
              4.3. evapi_close()

        5. Event routes

              5.1. evapi:connection-new
              5.2. evapi:connection-closed
              5.3. evapi:message-received

        6. Exported pseudo-variables

   List of Examples

   1.1. Set workers parameter
   1.2. Set bind_addr parameter
   1.3. evapi_relay usage
   1.4. TCP message
   1.5. evapi_async_relay usage
   1.6. evapi_evapi usage

Chapter 1. Admin Guide

   Table of Contents

   1. Overview
   2. Dependencies

        2.1. Kamailio Modules
        2.2. External Libraries or Applications

   3. Parameters

        3.1. workers (int)
        3.2. bind_addr (str)

   4. Functions

        4.1. evapi_relay(evdata)
        4.2. evapi_async_relay(evdata)
        4.3. evapi_close()

   5. Event routes

        5.1. evapi:connection-new
        5.2. evapi:connection-closed
        5.3. evapi:message-received

   6. Exported pseudo-variables

1. Overview

   This module pushes event details to remote applications, via TCP.

2. Dependencies

   2.1. Kamailio Modules
   2.2. External Libraries or Applications

2.1. Kamailio Modules

   The following modules must be loaded before this module:
     * tm - (optional) needed only by evapi_async_relay()

2.2. External Libraries or Applications

   The following libraries or applications must be installed before
   running Kamailio with this module loaded:
     * libev

3. Parameters

   3.1. workers (int)
   3.2. bind_addr (str)

3.1. workers (int)

   Number of worker processes to be started to handle incoming messages
   from remote applications.

   Default value is 1.

   Example 1.1. Set workers parameter
...
modparam("evapi", "workers", 2)
...

3.2. bind_addr (str)

   Local IP and port to listen on for incoming TCP connections.

   Default value is "127.0.0.1:8448".

   Example 1.2. Set bind_addr parameter
...
modparam("evapi", "bind_addr", "1.2.3.4:8228")
...

4. Functions

   4.1. evapi_relay(evdata)
   4.2. evapi_async_relay(evdata)
   4.3. evapi_close()

4.1. evapi_relay(evdata)

   Relay the event data give as parameter to connected applications. The
   format on the network is netstring with evdata payload.

   This function can be used from ANY_ROUTE.

   Example 1.3. evapi_relay usage
...
evapi_relay("{ \"event\": \"test\",\n \"data\": { \"fU\": \"$fU\" }\n}");
...

   The above exaple will send the following message over tcp:

   Example 1.4. TCP message
...
47:{
 "event": "test",
 "data": { "fU": "test" }
},
...

4.2. evapi_async_relay(evdata)

   Relay the event data give as parameter to connected applications. The
   format on the network is netstring with evdata payload. Before
   evaluating the parameter, the request processing is suspended using tm
   module.

   This function can be used from REQUEST_ROUTE.

   Example 1.5. evapi_async_relay usage
...
evapi_relay("{ \"event\": \"suspend\",\n \"data\":"
        " { \"index\": \"$T(id_index)\", \"label\": \"$T(id_label)\" }\n}");
...

4.3. evapi_close()

   Close evapi current client connection.

   This function can be used from ANY_ROUTE.

   Example 1.6. evapi_evapi usage
...
event_route[evapi:connection-new] {
  if($evapi(srcaddr)!="127.0.0.1") {
    evapi_close();
    exit;
  }
}
...

5. Event routes

   5.1. evapi:connection-new
   5.2. evapi:connection-closed
   5.3. evapi:message-received

5.1. evapi:connection-new

   If defined, the module calls event_route[evapi:connection-new] when a
   new client is connected.
...
event_route[evapi:connection-new] {
    xlog("new connection from $evapi(srcaddr):$evapi(srcport)\n");
}
...

5.2. evapi:connection-closed

   If defined, the module calls event_route[evapi:connection-closed] when
   a client connection is closed.
...
event_route[evapi:connection-closed] {
    xlog("connection closed by $evapi(srcaddr):$evapi(srcport)\n");
}
...

5.3. evapi:message-received

   If defined, the module calls event_route[evapi:message-received] when a
   message is received from a client.
...
event_route[evapi:message-received] {
    xlog("received [$evapi(msg)] from $evapi(srcaddr):$evapi(srcport)\n");
}
...

6. Exported pseudo-variables

     * $evapi(srcaddr) - source ip
     * $evapi(srcport) - source port
     * $evapi(msg) - received event message
     * $evapi(conidx) - internal connexion index

   Exported pseudo-variables are documented at
   http://www.kamailio.org/wiki/.
